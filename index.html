<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±ä½œæ–‡ãƒ‘ã‚ºãƒ«</title>

<style>
body{
  font-family: sans-serif;
  max-width:900px;
  margin:auto;
  padding:20px;
  background:#f6f7fb;
}

.card{
  background:white;
  padding:18px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  margin-bottom:14px;
}

.word, .built{
  padding:12px 16px;
  margin:6px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:17px;
}

.word{ background:#222; color:white; }
.built{ background:#dfe6ff; }

.correct{ color:#0a7f2e; font-weight:bold; }
.wrong{ color:#c0392b; font-weight:bold; }

.bigResult{
  text-align:center;
  font-size:24px;
  font-weight:bold;
  margin:20px 0;
}

button.ctrl{
  padding:14px 20px;
  margin:8px;
  border:none;
  border-radius:10px;
  background:#4a6cf7;
  color:white;
  cursor:pointer;
  font-size:17px;
}

button.ctrl.gray{
  background:#777;
}

.missBox{
  background:#fff7ed;
  border-left:6px solid #fb923c;
  padding:14px;
  border-radius:10px;
  margin-top:16px;
}

@media (max-width:600px){
  .word, .built{
    width:100%;
    font-size:18px;
  }
}
</style>
</head>

<body>

<h1>è‹±ä½œæ–‡ ä¸¦ã¹æ›¿ãˆãƒ‘ã‚ºãƒ«</h1>

<div id="app"></div>

<script>

/********************
 å¤§å•ã”ã¨ã«åŒºåˆ‡ã‚‹ï¼
********************/

const sections = [
  {
    title:"å¤§å•1",
    questions:[
      {
        jp:"ã©ã“ã§ã‚‚ãƒ‰ã‚¢ãŒã‚ã£ãŸã‚‰ã„ã„ã¨æ€ã„ã¾ã›ã‚“ã‹ã€‚",
        tokens:["an","anywhere","door","if","wouldn't","be","we","had","it","nice"],
        answer:"wouldn't it be nice if we had an anywhere door?",
        explain:"ä»®å®šæ³•ã€‚Wouldn't it be nice if ï½ ã¯è¶…é »å‡ºã€‚"
      },
      {
        jp:"ç§ã«ã¨ã£ã¦ã“ã®æ­Œã‚’æ­Œã†ã®ã¯ã¨ã¦ã‚‚é›£ã—ã„ã§ã™ã€‚",
        tokens:["this","song","for","sing","me","it","very","difficult","to","is"],
        answer:"it is very difficult for me to sing this song.",
        explain:"It is + å½¢å®¹è© + for + äºº + to å‹•è©ã€‚"
      },
      {
        jp:"å¤§é›ªã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€åˆ—è»Šã¯æ™‚é–“é€šã‚Šã«åˆ°ç€ã—ã¾ã—ãŸã€‚",
        tokens:["the","train","on","the","heavy","snow","arrived","time","spite","of","in"],
        answer:"the train arrived on time in spite of the heavy snow.",
        explain:"in spite of = ï½ã«ã‚‚ã‹ã‹ã‚ã‚‰ãš"
      },
      {
        jp:"ç§ãŸã¡ã¯ä»Šæœæ—©ãã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚",
        tokens:["preparing","this","morning","been","early","from","the","party","for","we've"],
        answer:"we've been preparing for the party from early this morning.",
        explain:"ç¾åœ¨å®Œäº†é€²è¡Œå½¢ã€‚"
      },
      {
        jp:"æ¯æ—¥30åˆ†ã®é‹å‹•ã‚’ã™ã‚‹ã“ã¨ã¯ã‚ãªãŸã®å¥åº·ã«ã‚ˆã„ã§ã—ã‚‡ã†ã€‚",
        tokens:["every","day","of","thirty","health","exercise","would","for","good","your","be","minutes"],
        answer:"thirty minutes of exercise every day would be good for your health.",
        explain:"minutes of ï½ ã§ã€Œï½ã®åˆ†ã€ã€‚"
      }
    ]
  }
];


/********************
 çŠ¶æ…‹
********************/

let sectionIndex = 0;
let questionIndex = 0;
let built = [];
let pool = [];
let score = 0;
let wrongList = []; // â†é–“é•ãˆãŸå•é¡Œä¿å­˜ï¼ˆç¥æ©Ÿèƒ½ï¼‰

const app = document.getElementById("app");


/********************
 æç”»
********************/

function shuffle(arr){
  return [...arr].sort(()=>Math.random()-0.5);
}

function renderQuestion(){
  const q = sections[sectionIndex].questions[questionIndex];

  app.innerHTML = `
    <div class="card">
      <h2>${sections[sectionIndex].title}ï¼ˆ${questionIndex+1}/${sections[sectionIndex].questions.length}ï¼‰</h2>
      <p><b>${q.jp}</b></p>

      <h3>ã‚ãªãŸã®æ–‡</h3>
      <div id="built"></div>

      <h3>å˜èª</h3>
      <div id="pool"></div>

      <p id="result"></p>
      <p id="explain"></p>
    </div>
  `;

  built = [];
  pool = shuffle(q.tokens);

  drawWords();
}

function drawWords(){
  const builtDiv = document.getElementById("built");
  const poolDiv = document.getElementById("pool");

  builtDiv.innerHTML = "";
  poolDiv.innerHTML = "";

  built.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "built";
    btn.onclick = ()=>{
      pool.push(w);
      built.splice(i,1);
      drawWords();
    };
    builtDiv.appendChild(btn);
  });

  pool.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "word";
    btn.onclick = ()=>{
      built.push(w);
      pool.splice(i,1);
      drawWords();
      autoCheck();
    };
    poolDiv.appendChild(btn);
  });
}


/********************
 æ¡ç‚¹ï¼ˆå¤§æ–‡å­—ç„¡è¦–ï¼‰
********************/

function normalize(s){
  return s.trim().replace(/\s+/g," ").toLowerCase();
}

function autoCheck(){
  const q = sections[sectionIndex].questions[questionIndex];

  if(built.length !== q.tokens.length) return;

  let sentence = built.join(" ");

  if(!sentence.endsWith(".") && !sentence.endsWith("?")){
    sentence += q.answer.endsWith("?") ? "?" : ".";
  }

  const result = document.getElementById("result");
  const explain = document.getElementById("explain");

  if(normalize(sentence) === normalize(q.answer)){
    result.innerHTML = `<span class="correct">æ­£è§£ï¼</span>`;
    score++;
  }else{
    result.innerHTML = `<span class="wrong">ä¸æ­£è§£ï¼</span><br>æ­£è§£ï¼š${q.answer}`;

    wrongList.push({
      jp:q.jp,
      correct:q.answer,
      explain:q.explain
    });
  }

  explain.textContent = q.explain;

  setTimeout(nextQuestion,1200);
}


/********************
 æ¬¡ã®å•é¡Œ
********************/

function nextQuestion(){
  questionIndex++;

  if(questionIndex >= sections[sectionIndex].questions.length){
    showFinal();
  }else{
    renderQuestion();
  }
}


/********************
 å¤§å•çµæœè¡¨ç¤º
********************/

function showFinal(){

  let missHTML = "";

  if(wrongList.length > 0){
    missHTML = `
      <div class="missBox">
        <h3>å¾©ç¿’ã—ã‚ˆã†ï¼é–“é•ãˆãŸå•é¡Œ</h3>
        ${wrongList.map(w=>`
          <p><b>${w.jp}</b><br>
          æ­£è§£ï¼š${w.correct}<br>
          è§£èª¬ï¼š${w.explain}</p>
        `).join("")}
      </div>
    `;
  }

  app.innerHTML = `
    <div class="card">
      <div class="bigResult">
        ${sections[sectionIndex].title} çµæœ<br><br>
        ${score} / ${sections[sectionIndex].questions.length} æ­£è§£ï¼
      </div>

      ${missHTML}

      <div style="text-align:center;">
        <button class="ctrl" onclick="retrySection()">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
        <button class="ctrl gray" onclick="reviewWrong()">é–“é•ã„ã ã‘å¾©ç¿’</button>
        <button class="ctrl gray" onclick="nextSection()">æ¬¡ã®å¤§å•ã¸</button>
      </div>
    </div>
  `;
}


/********************
 å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼ˆç¥æ©Ÿèƒ½ï¼‰
********************/

function reviewWrong(){

  if(wrongList.length === 0){
    alert("é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼å®Œç’§ï¼");
    return;
  }

  sections.splice(sectionIndex+1,0,{
    title:"å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰",
    questions: wrongList.map(w=>({
      jp:w.jp,
      tokens: shuffle(w.correct.replace(/[?.]/g,"").split(" ")),
      answer:w.correct,
      explain:w.explain
    }))
  });

  wrongList = [];
  score = 0;
  questionIndex = 0;
  sectionIndex++;

  renderQuestion();
}


/********************
 ãƒœã‚¿ãƒ³æ“ä½œ
********************/

function retrySection(){
  questionIndex = 0;
  score = 0;
  wrongList = [];
  renderQuestion();
}

function nextSection(){
  sectionIndex++;

  if(sectionIndex >= sections.length){
    app.innerHTML = `
      <div class="card">
        <div class="bigResult">ğŸ‰ å…¨å¤§å•ã‚¯ãƒªã‚¢ï¼</div>
      </div>
    `;
    return;
  }

  questionIndex = 0;
  score = 0;
  wrongList = [];
  renderQuestion();
}


/********************
 èµ·å‹•
********************/

renderQuestion();

</script>

</body>
</html>
