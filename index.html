<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¸¦ã¹æ›¿ãˆè‹±ä½œæ–‡ãƒ‘ã‚ºãƒ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body{
  font-family: "Segoe UI", sans-serif;
  max-width: 980px;
  margin: 28px auto;
  background:#f7f8fb;
  padding: 0 12px 80px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom: 10px;
}

h1{ margin: 6px 0; font-size: 22px; }

.question{
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
  margin-bottom:16px;
}

.jp{
  font-size:20px;
  font-weight:800;
  color:#111;
  padding:12px 14px;
  border-left:6px solid #4a6cf7;
  background:linear-gradient(90deg,#eef2ff,#ffffff);
  border-radius:10px;
}

.history{
  margin-top:10px;
  font-size:14px;
  color:#555;
}

.box{
  border:2px dashed #cfd3dc;
  padding:12px;
  min-height:70px;
  margin:10px 0;
  border-radius:12px;
  background:white;
}

button{
  margin:5px 6px 0 0;
  padding:10px 14px;
  cursor:pointer;
  border-radius:10px;
  border:none;
  font-size:15px;
}

.word{ background:#222; color:white; }
.word:disabled{ opacity:.45; cursor:not-allowed; }

.built{ background:#e9eefc; }
.built:disabled{ opacity:.45; cursor:not-allowed; }

.controls{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 6px; }
.ctrl{ background:#111827; color:white; }
.ctrl2{ background:#e5e7eb; color:#111; }
.ctrl3{ background:#10b981; color:white; }

.correct{ color:#0a7f2e; font-weight:900; font-size:18px; white-space:pre-line; }
.wrong{ color:#c0392b; font-weight:900; font-size:18px; white-space:pre-line; }

.explain{
  margin-top:12px;
  padding:14px;
  background:#ffffff;
  border-left:6px solid #4a6cf7;
  border-radius:10px;
  line-height:1.65;
}

.hint{
  margin-top:12px;
  padding:14px;
  background:#ecfdf5;
  border-left:6px solid #10b981;
  border-radius:10px;
  line-height:1.65;
}

.answer-log{
  margin-top:12px;
  padding:12px;
  background:#fff7ed;
  border-left:6px solid #fb923c;
  border-radius:10px;
  font-size:14px;
  line-height:1.6;
}

/* ç·¨é›†ãƒ‘ãƒãƒ« */
.editor{
  background:white;
  border-radius:14px;
  padding:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
  margin-top:16px;
  display:none;
}
.editor h2{
  margin: 0 0 10px;
  font-size:18px;
}
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media (max-width: 760px){
  .grid{ grid-template-columns: 1fr; }
}
.field label{
  display:block;
  font-size:12px;
  color:#555;
  margin: 2px 0 6px;
  font-weight:700;
}
.field input, .field textarea, .field select{
  width:100%;
  border:1px solid #d1d5db;
  border-radius:10px;
  padding:10px;
  font-size:14px;
  background:#fff;
  box-sizing:border-box;
}
.field textarea{ min-height: 88px; resize: vertical; }
.small{
  color:#6b7280; font-size:12px; margin-top:6px;
}
.row{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.danger{ background:#ef4444; color:white; }
</style>
</head>

<body>

<div class="header">
  <h1>ä¸¦ã¹æ›¿ãˆè‹±ä½œæ–‡ãƒ‘ã‚ºãƒ«</h1>
  <div class="row">
    <button class="ctrl2" onclick="toggleEditor()">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    <button class="ctrl2" onclick="clearHistory()">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<div class="question">
  <div id="jp" class="jp"></div>
  <div id="history" class="history"></div>
</div>

<div class="controls">
  <button class="ctrl2" onclick="reset()">ãƒªã‚»ãƒƒãƒˆ</button>
  <button class="ctrl" onclick="next()">æ¬¡ã®å•é¡Œ</button>
  <button class="ctrl3" onclick="toggleHint()">ãƒ’ãƒ³ãƒˆ</button>
</div>

<h3>ã‚ãªãŸã®æ–‡ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™ï¼‰</h3>
<div id="built" class="box"></div>

<h3>å˜èªï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ä¸Šã«å…¥ã‚‹ï¼‰</h3>
<div id="pool" class="box"></div>

<p id="result"></p>
<div id="explain"></div>
<div id="hint" class="hint" style="display:none;"></div>
<div id="log"></div>

<!-- ç·¨é›†ãƒ‘ãƒãƒ« -->
<div id="editor" class="editor">
  <h2>å•é¡Œç·¨é›†</h2>
  <div class="row" style="margin-bottom:10px;">
    <div class="field" style="min-width:260px; flex:1;">
      <label>ç·¨é›†ã™ã‚‹å•é¡Œ</label>
      <select id="ed_select" onchange="loadEditorFromSelected()"></select>
      <div class="small">â€»ç·¨é›†ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚</div>
    </div>
    <div class="row">
      <button class="ctrl2" onclick="addQuestion()">ï¼‹å•é¡Œã‚’è¿½åŠ </button>
      <button class="danger" onclick="deleteQuestion()">ã“ã®å•é¡Œã‚’å‰Šé™¤</button>
      <button class="ctrl2" onclick="resetQuestionsToDefault()">å•é¡Œã‚’åˆæœŸåŒ–ï¼ˆå…ƒã«æˆ»ã™ï¼‰</button>
    </div>
  </div>

  <div class="grid">
    <div class="field">
      <label>æ—¥æœ¬èªï¼ˆå•é¡Œæ–‡ï¼‰</label>
      <textarea id="ed_jp"></textarea>
    </div>
    <div class="field">
      <label>æ­£è§£è‹±æ–‡ï¼ˆanswerï¼‰</label>
      <textarea id="ed_answer"></textarea>
      <div class="small">æ¡ç‚¹ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¦åˆ¤å®šã—ã¾ã™ã€‚</div>
    </div>

    <div class="field">
      <label>å˜èªã‚¿ã‚¤ãƒ«ï¼ˆtokensï¼‰</label>
      <textarea id="ed_tokens" placeholder="1è¡Œã«1ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚OKï¼‰"></textarea>
      <div class="small">ä¾‹ï¼šã€Œthis summerã€ã¿ãŸã„ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ã‚¿ã‚¤ãƒ«ã‚‚OKã€‚</div>
    </div>
    <div class="field">
      <label>ãƒ’ãƒ³ãƒˆï¼ˆhintï¼‰</label>
      <textarea id="ed_hint"></textarea>
    </div>

    <div class="field" style="grid-column: 1 / -1;">
      <label>è§£èª¬ï¼ˆexplainï¼šHTMLå¯ï¼‰</label>
      <textarea id="ed_explain"></textarea>
      <div class="small">ä¾‹ï¼š&lt;b&gt;å¼·èª¿&lt;/b&gt; ã‚„ &lt;br&gt; æ”¹è¡ŒãŒä½¿ãˆã¾ã™ã€‚</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="ctrl" onclick="saveEditorToQuestions()">ã“ã®å•é¡Œã‚’ä¿å­˜</button>
  </div>
</div>

<script>
/*********************
 Cookieï¼ˆå±¥æ­´ç”¨ï¼‰
*********************/
function setCookie(name, value, days=365){
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value))
    + ";expires=" + d.toUTCString() + ";path=/";
}
function getCookie(name){
  const cookies = document.cookie.split("; ");
  for(const c of cookies){
    const parts = c.split("=");
    const k = parts[0];
    const v = parts.slice(1).join("=");
    if(k===name){
      try{ return JSON.parse(decodeURIComponent(v)); }catch{ return null; }
    }
  }
  return null;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/*********************
 å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
*********************/
const DEFAULT_QUESTIONS = [
  // å…ƒã®5å•ï¼‹ã‚ãªãŸãŒé€ã£ã¦ãã‚ŒãŸè¿½åŠ åˆ†ï¼ˆå‰å›ã¾ã§å…¥ã£ã¦ã‚‹ã‚‚ã®ã‚’æƒ³å®šï¼‰
  // ã“ã“ã¯ã€Œå‰å›ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã«å…¥ã‚Œã¦ã„ãŸã‚‚ã®ã€ã‚’æ®‹ã—ã¤ã¤ã€ç·¨é›†æ©Ÿèƒ½ã§ç›´ã—ã¦ã„ã‘ã¾ã™ã€‚
  // â€»æ—¢ã«ã‚ãªãŸã®ç’°å¢ƒã§å‹•ã„ã¦ã„ã‚‹ãªã‚‰ã€ã“ã®DEFAULT_QUESTIONSã¯å‰å›ã®å†…å®¹ã§OKã§ã™ã€‚
  {
    jp:"ã©ã“ã§ã‚‚ãƒ‰ã‚¢ãŒã‚ã£ãŸã‚‰ã„ã„ã¨æ€ã„ã¾ã›ã‚“ã‹ã€‚",
    tokens:["an","anywhere","door","if","wouldn't","be","we","had","it","nice"],
    answer:"Wouldn't it be nice if we had an anywhere door?",
    hint:"å‡ºã ã—ã¯ Wouldn't it be nice if...ï¼ˆä»®å®šæ³•ï¼‰ã€‚",
    explain:"<b>Wouldn't it be nice if + S + éå»å½¢ ?</b> ã®å®šç•ªã€‚"
  },
  {
    jp:"ç§ã«ã¨ã£ã¦ã“ã®æ­Œã‚’æ­Œã†ã®ã¯ã¨ã¦ã‚‚é›£ã—ã„ã§ã™ã€‚",
    tokens:["this","song","for","sing","me","it","very","difficult","to","is"],
    answer:"It is very difficult for me to sing this song.",
    hint:"It is + å½¢å®¹è© + for + äºº + to + å‹•è©",
    explain:"It ãŒä»®ä¸»èªã€‚<b>It is difficult for me to ...</b>"
  },
  {
    jp:"å¤§é›ªã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€åˆ—è»Šã¯æ™‚é–“é€šã‚Šã«åˆ°ç€ã—ã¾ã—ãŸã€‚",
    tokens:["the","train","on","the","heavy","snow","arrived","time","spite","of","in"],
    answer:"The train arrived on time in spite of the heavy snow.",
    hint:"in spite of + åè© / on time",
    explain:"<b>in spite of</b> ã®å¾Œã¯åè©ã€‚"
  },
  {
    jp:"ç§ãŸã¡ã¯ä»Šæœæ—©ãã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚",
    tokens:["preparing","this","morning","been","early","from","the","party","for","we've"],
    answer:"We've been preparing for the party from early this morning.",
    hint:"have been + -ing",
    explain:"ç¾åœ¨å®Œäº†é€²è¡Œå½¢ã€‚"
  },
  {
    jp:"æ¯æ—¥30åˆ†ã®é‹å‹•ã‚’ã™ã‚‹ã“ã¨ã¯ã‚ãªãŸã®å¥åº·ã«ã‚ˆã„ã§ã—ã‚‡ã†ã€‚",
    tokens:["every","day","of","thirty","health","exercise","would","for","good","your","be","minutes"],
    answer:"Thirty minutes of exercise every day would be good for your health.",
    hint:"Thirty minutes of exercise ãŒä¸»èª",
    explain:"minutes of ã§ã€Œä½•ã®åˆ†ï¼Ÿã€ã€‚"
  }
];

/*********************
 å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆç·¨é›†ä¿å­˜ï¼šlocalStorageï¼‰
*********************/
const LS_KEY = "englishPuzzleQuestions_v2";
function loadQuestions(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return DEFAULT_QUESTIONS;
  try{
    const q = JSON.parse(raw);
    if(Array.isArray(q) && q.length) return q;
    return DEFAULT_QUESTIONS;
  }catch{
    return DEFAULT_QUESTIONS;
  }
}
function saveQuestions(qs){
  localStorage.setItem(LS_KEY, JSON.stringify(qs));
}

/*********************
 ã‚¢ãƒ—ãƒªçŠ¶æ…‹
*********************/
let questions = loadQuestions();
let historyData = getCookie("englishPuzzleHistory") || {};
let index = 0;
let pool = [];
let built = [];
let locked = false;
let hintOpen = false;
let editorOpen = false;

function shuffle(arr){ return [...arr].sort(()=>Math.random()-0.5); }

// æ¡ç‚¹ç”¨ï¼šå¤§æ–‡å­—å°æ–‡å­—ã¯ç„¡è¦–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
function normalizeForGrade(s){
  return String(s).trim().replace(/\s+/g," ").toLowerCase();
}
function makeSentence(){
  // ã“ã“ã§æ–‡é ­å¤§æ–‡å­—åŒ–ã¯ã€Œã—ã¦ã‚‚ã—ãªãã¦ã‚‚ã€æ¡ç‚¹ã«å½±éŸ¿ã—ãªã„
  let s = built.join(" ").trim();
  if(!s) return "";
  // å¥èª­ç‚¹ã¯æ­£è§£ã«åˆã‚ã›ã¦ä»˜ã‘ã‚‹
  const ans = questions[index].answer || "";
  const needQ = ans.trim().endsWith("?");
  if(!/[?.!]$/.test(s)){
    s += needQ ? "?" : ".";
  }
  return s;
}

// ãƒŸã‚¹å‚¾å‘ï¼ˆæ–‡é ­å¤§æ–‡å­—ã¯å»ƒæ­¢ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
function diffKeys(user, ans){
  const keys = [];
  const u = normalizeForGrade(user);
  const a = normalizeForGrade(ans);

  if(u.slice(-1) !== a.slice(-1)) keys.push("æ–‡æœ«ã®è¨˜å·");

  const uw = u.replace(/[?.!]$/,"").split(/\s+/);
  const aw = a.replace(/[?.!]$/,"").split(/\s+/);
  if(uw.join("|") !== aw.join("|")) keys.push("èªé †");

  return keys;
}

/*********************
 è¡¨ç¤º
*********************/
function renderHistory(){
  const h = historyData[index];
  const div = document.getElementById("history");

  if(!h){
    div.innerHTML = "ğŸ“Š ã“ã®å•é¡Œã¯ã¾ã è§£ã„ã¦ã„ã¾ã›ã‚“";
    return;
  }

  const tries = h.tries ?? 0;
  const win = h.correctCount ?? 0;
  const lose = h.wrongCount ?? 0;

  const last = h.lastAnswer ? `<br>ğŸ“ å‰å›ã®è§£ç­”ï¼š <i>${escapeHtml(h.lastAnswer)}</i>` : "";
  const lastMist = h.lastMistake ? `<br>âš ï¸ å‰å›ã®ãƒŸã‚¹ï¼š <i>${escapeHtml(h.lastMistake)}</i>` : "";
  const common = h.commonMistake ? `<br>ğŸ“Œ ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼š <b>${escapeHtml(h.commonMistake)}</b>` : "";

  div.innerHTML = `ğŸ“Š è¨˜éŒ²ï¼š<b>${win}å‹ / ${lose}æ•—</b>ï¼ˆæŒ‘æˆ¦ ${tries}å›ï¼‰${last}${lastMist}${common}`;
}

function render(){
  const q = questions[index];
  document.getElementById("jp").textContent = `å•é¡Œ ${index+1}ï¼š ${q.jp}`;

  renderHistory();

  const hintDiv = document.getElementById("hint");
  if(hintOpen){
    hintDiv.style.display = "block";
    const h = historyData[index] || {};
    const common = h.commonMistake ? `<br>ğŸ“Œ ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼š<b>${escapeHtml(h.commonMistake)}</b>` : "";
    let recent = "";
    if(Array.isArray(h.mistakes) && h.mistakes.length){
      recent += "<br><b>æœ€è¿‘ã®ãƒŸã‚¹ï¼ˆæœ€å¤§5ï¼‰</b><br><ol style='margin:6px 0 0 18px; padding:0;'>";
      h.mistakes.forEach(m=> recent += `<li style='margin:4px 0;'>${escapeHtml(m)}</li>`);
      recent += "</ol>";
    }
    hintDiv.innerHTML = `<b>ãƒ’ãƒ³ãƒˆ</b><br>${q.hint || ""}${common}${recent}`;
  }else{
    hintDiv.style.display = "none";
    hintDiv.innerHTML = "";
  }

  const poolDiv = document.getElementById("pool");
  const builtDiv = document.getElementById("built");

  poolDiv.innerHTML = "";
  builtDiv.innerHTML = "";

  pool.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "word";
    btn.disabled = locked;
    btn.onclick = ()=>{
      built.push(w);
      pool.splice(i,1);
      render();
      autoCheck();
    };
    poolDiv.appendChild(btn);
  });

  built.forEach((w,i)=>{
    const btn = document.createElement("button");
    btn.textContent = w;
    btn.className = "built";
    btn.disabled = locked;
    btn.onclick = ()=>{
      pool.push(w);
      built.splice(i,1);
      render();
    };
    builtDiv.appendChild(btn);
  });
}

function reset(){
  pool = shuffle(questions[index].tokens || []);
  built = [];
  locked = false;
  hintOpen = false;

  document.getElementById("result").textContent = "";
  document.getElementById("explain").innerHTML = "";
  document.getElementById("hint").innerHTML = "";
  document.getElementById("hint").style.display = "none";
  document.getElementById("log").innerHTML = "";

  render();
}

function autoCheck(){
  if(built.length !== (questions[index].tokens || []).length) return;

  locked = true;

  const sentence = makeSentence();
  const ans = questions[index].answer || "";
  const correct = (normalizeForGrade(sentence) === normalizeForGrade(ans));

  const result = document.getElementById("result");
  const explain = document.getElementById("explain");
  const log = document.getElementById("log");

  // ===== å±¥æ­´ä¿å­˜ï¼ˆCookieï¼‰ =====
  const prev = historyData[index] || {};
  const tries = (prev.tries ?? 0) + 1;
  const correctCount = (prev.correctCount ?? 0) + (correct ? 1 : 0);
  const wrongCount = (prev.wrongCount ?? 0) + (correct ? 0 : 1);

  const lastAnswer = sentence;
  const lastMistake = correct ? null : sentence;

  // ã‚ˆãã‚ã‚‹ãƒŸã‚¹ï¼ˆèªé †ï¼æ–‡æœ«è¨˜å·ã®ã¿ï¼‰
  const diffs = prev.diffs || {order:0, end:0};
  if(!correct){
    const keys = diffKeys(sentence, ans);
    if(keys.includes("èªé †")) diffs.order += 1;
    if(keys.includes("æ–‡æœ«ã®è¨˜å·")) diffs.end += 1;
  }

  let commonMistake = null;
  const entries = [
    ["èªé †", diffs.order],
    ["æ–‡æœ«ã®è¨˜å·", diffs.end],
  ];
  entries.sort((a,b)=>b[1]-a[1]);
  if(entries[0][1] > 0) commonMistake = entries[0][0];

  // æœ€è¿‘ã®ãƒŸã‚¹æœ€å¤§5ä»¶
  const mistakes = Array.isArray(prev.mistakes) ? prev.mistakes.slice(0) : [];
  if(!correct) mistakes.unshift(sentence);

  const uniq = [];
  const seen = new Set();
  for(const m of mistakes){
    if(!seen.has(m)){
      uniq.push(m);
      seen.add(m);
    }
    if(uniq.length >= 5) break;
  }

  historyData[index] = {
    tries, correctCount, wrongCount,
    lastAnswer, lastMistake,
    commonMistake, diffs,
    mistakes: uniq,
  };
  setCookie("englishPuzzleHistory", historyData);

  // ===== è¡¨ç¤º =====
  if(correct){
    result.textContent = "æ­£è§£ï¼ï¼ğŸ‰";
    result.className = "correct";
    log.innerHTML = "";
  }else{
    result.textContent = `ä¸æ­£è§£ï¼\næ­£è§£ï¼š ${questions[index].answer}`;
    result.className = "wrong";

    const keys = diffKeys(sentence, ans);
    log.innerHTML = `
      <div class="answer-log">
        â—ã‚ãªãŸã®è§£ç­”ï¼š<br>${escapeHtml(sentence)}<br><br>
        ğŸ“Œ ãƒŸã‚¹å‚¾å‘ï¼š<b>${escapeHtml(commonMistake || (keys.join(" / ") || "è¡¨è¨˜"))}</b>
      </div>
    `;
  }

  explain.innerHTML = `<div class="explain"><b>è§£èª¬ï¼š</b><br>${questions[index].explain || ""}</div>`;
  renderHistory();

  if(hintOpen){
    // ãƒ’ãƒ³ãƒˆã‚’é–‹ã„ã¦ã„ãŸã‚‰æ›´æ–°
    render();
  }
}

function next(){
  index = (index + 1) % questions.length;
  reset();
}

function toggleHint(){
  hintOpen = !hintOpen;
  render();
}

/*********************
 å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
*********************/
function clearHistory(){
  if(!confirm("å±¥æ­´ï¼ˆæ­£è§£/ä¸æ­£è§£ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚OKï¼Ÿ")) return;
  historyData = {};
  setCookie("englishPuzzleHistory", historyData);
  renderHistory();
  alert("å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
}

/*********************
 ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
*********************/
function toggleEditor(){
  editorOpen = !editorOpen;
  const el = document.getElementById("editor");
  el.style.display = editorOpen ? "block" : "none";
  if(editorOpen){
    refreshEditorSelect();
    loadEditorFromSelected();
  }
}

function refreshEditorSelect(){
  const sel = document.getElementById("ed_select");
  sel.innerHTML = "";
  questions.forEach((q,i)=>{
    const opt = document.createElement("option");
    const label = (q.jp || "").slice(0,22);
    opt.value = String(i);
    opt.textContent = `${i+1}. ${label}${(q.jp||"").length>22 ? "â€¦" : ""}`;
    sel.appendChild(opt);
  });
  sel.value = String(index); // ä»Šè¡¨ç¤ºä¸­ã®å•é¡Œã‚’é¸æŠ
}

function loadEditorFromSelected(){
  const sel = document.getElementById("ed_select");
  const i = Number(sel.value);
  const q = questions[i];
  document.getElementById("ed_jp").value = q.jp || "";
  document.getElementById("ed_answer").value = q.answer || "";
  document.getElementById("ed_tokens").value = (q.tokens || []).join("\n");
  document.getElementById("ed_hint").value = q.hint || "";
  document.getElementById("ed_explain").value = q.explain || "";
}

function saveEditorToQuestions(){
  const sel = document.getElementById("ed_select");
  const i = Number(sel.value);

  const jp = document.getElementById("ed_jp").value.trim();
  const answer = document.getElementById("ed_answer").value.trim();
  const tokensRaw = document.getElementById("ed_tokens").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const hint = document.getElementById("ed_hint").value.trim();
  const explain = document.getElementById("ed_explain").value.trim();

  if(!jp || !answer || tokensRaw.length === 0){
    alert("æ—¥æœ¬èª / æ­£è§£è‹±æ–‡ / tokens ã¯å¿…é ˆã§ã™ã€‚");
    return;
  }

  questions[i] = { jp, answer, tokens: tokensRaw, hint, explain };
  saveQuestions(questions);

  // è¡¨ç¤ºä¸­ã®å•é¡ŒãŒç·¨é›†å¯¾è±¡ãªã‚‰ã€ãã®ã¾ã¾åæ˜ 
  if(i === index){
    reset();
  }else{
    renderHistory();
  }
  alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
  refreshEditorSelect();
  document.getElementById("ed_select").value = String(i);
}

function addQuestion(){
  const newQ = {
    jp:"ï¼ˆã“ã“ã«æ—¥æœ¬èªï¼‰",
    tokens:["(token1)","(token2)"],
    answer:"(answer).",
    hint:"ï¼ˆãƒ’ãƒ³ãƒˆï¼‰",
    explain:"ï¼ˆè§£èª¬ï¼‰"
  };
  questions.push(newQ);
  saveQuestions(questions);
  refreshEditorSelect();
  document.getElementById("ed_select").value = String(questions.length-1);
  loadEditorFromSelected();
  alert("å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ç·¨é›†ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
}

function deleteQuestion(){
  const sel = document.getElementById("ed_select");
  const i = Number(sel.value);
  if(questions.length <= 1){
    alert("æœ€å¾Œã®1å•ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
    return;
  }
  if(!confirm("ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã€‚OKï¼Ÿ")) return;

  questions.splice(i,1);
  saveQuestions(questions);

  // indexèª¿æ•´
  if(index >= questions.length) index = 0;

  refreshEditorSelect();
  document.getElementById("ed_select").value = String(index);
  loadEditorFromSelected();
  reset();
  alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
}

function resetQuestionsToDefault(){
  if(!confirm("å•é¡Œã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ï¼ˆç·¨é›†å†…å®¹ã¯æ¶ˆãˆã¾ã™ï¼‰ã€‚OKï¼Ÿ")) return;
  localStorage.removeItem(LS_KEY);
  questions = loadQuestions();
  // indexã‚‚å®‰å…¨å´ã«
  index = Math.min(index, questions.length-1);
  refreshEditorSelect();
  loadEditorFromSelected();
  reset();
  alert("å•é¡Œã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚");
}

// åˆæœŸåŒ–
reset();
</script>

</body>
</html>
